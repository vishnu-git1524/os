# Theera OS AppArmor profile for Firefox
# Provides additional security isolation for web browsing

#include <tunables/global>

/usr/lib/firefox/firefox {
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/dbus-session-strict>
  #include <abstractions/dbus-accessibility-strict>
  #include <abstractions/desktop>
  #include <abstractions/fonts>
  #include <abstractions/gnome>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/p11-kit>
  #include <abstractions/ssl_certs>
  #include <abstractions/user-tmp>

  capability sys_admin,
  capability sys_chroot,
  capability sys_ptrace,
  capability setgid,
  capability setuid,

  # Network access
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,
  network netlink raw,

  # Firefox binaries and libraries
  /usr/lib/firefox/ r,
  /usr/lib/firefox/** rm,
  /usr/lib/firefox/firefox px,
  /usr/lib/firefox/firefox-bin cx -> firefox_plugin,

  # User profile and data
  owner @{HOME}/.mozilla/ rw,
  owner @{HOME}/.mozilla/** rwk,
  owner @{HOME}/.cache/mozilla/ rw,
  owner @{HOME}/.cache/mozilla/** rwk,

  # Downloads
  owner @{HOME}/Downloads/ r,
  owner @{HOME}/Downloads/** rw,
  owner @{HOME}/Desktop/ r,
  owner @{HOME}/Desktop/** rw,

  # System directories
  /etc/firefox/ r,
  /etc/firefox/** r,
  /etc/mime.types r,
  /etc/mailcap r,
  /usr/share/mozilla/ r,
  /usr/share/mozilla/** r,

  # Temporary files
  /tmp/ r,
  /tmp/** rw,
  /var/tmp/ r,
  /var/tmp/** rw,

  profile firefox_plugin {
    #include <abstractions/base>
    #include <abstractions/user-tmp>

    capability setgid,
    capability setuid,

    /usr/lib/firefox/plugin-container px,
    /usr/lib/mozilla/plugins/ r,
    /usr/lib/mozilla/plugins/** rm,

    owner @{HOME}/.mozilla/** rwk,
    owner /tmp/** rw,
  }
}
